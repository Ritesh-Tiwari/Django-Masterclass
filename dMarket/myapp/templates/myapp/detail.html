{% extends "myapp/base.html" %}
{% block body %}
<div class="d-flex p-4">
    <div>
        <img src="https://t4.ftcdn.net/jpg/04/73/25/49/360_F_473254957_bxG9yf4ly7OBO5I0O5KABlN930GwaMQz.jpg" alt=""
            srcset="" width="100%">

    </div>

    <div class="ps-4">
        <div class="fs-1 fw-bold mb-3">{{ product.name }}</div>
        <div class="mb-2"> {{ product.description}} </div>
        <div class="mb-2 text-success fw-bold"> $ {{ product.price}} </div>
        <div>
            <button id="checkout-button" class="btn btn-success btn-sm p-2 px-3 "> Buy </button>
        </div>
        <div id="myemail" hidden>{{ request.user.email }}</div>

    </div>

</div>
<script src="https://js.stripe.com/v3/"></script>
<script type="text/javascript">
    var stripe = Stripe('{{ stripe_publishable_key}}')
    var checkoutButton = document.getElementById('checkout-button')

    checkoutButton.addEventListener('click', function () {
        console.log("Button click")
        var email = document.getElementById('myemail').innerText
        console.log("email :", email)

        if (email.length == 0) {
            alert("email Not Found")
            return
        }
        fetch("{% url 'api_checkout_session' id=product.id %}", {
            method: 'POST',
            body: JSON.stringify({
                'email': email,
            })


        }).then(function (response) {
            return response.json()
        }).then(function (session) {
            return stripe.redirectToCheckout({ session_id: session.session_id })
        }).then(function (result) {
            if (result.error) {
                alert(result.error.message)
            }
        }).catch(function (error) {
            console.error('Error :', error)
        })
    })


</script>
{% endblock %}